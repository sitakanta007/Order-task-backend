generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

/* ========= CORE TABLES MANAGED BY DJANGO ========= */

/// Django customers (frontend users you manage via Django Admin; Node validates bcrypt)
model Customer {
  id         String   @id @db.Char(32)         // UUID stored as 32-char hex (no dashes)
  name       String   @db.VarChar(150)
  email      String   @unique(map: "email") @db.VarChar(254)
  password   String   @db.VarChar(255)         // bcrypt hash
  created_at DateTime @db.DateTime(6)

  @@map("customers_customer")
}

/// Products created in Django
model Product {
  id                 String        @id @db.Char(32)    // UUID hex(32)
  title              String        @db.VarChar(255)
  image_url          String?       @db.VarChar(500)
  description        String?       @db.LongText
  price              Decimal       @db.Decimal(10, 2)
  available_quantity Int
  created_at         DateTime      @db.DateTime(6)

  cartItems CartItem[]

  @@map("products_product")
}

/// Orders created at checkout (header)
model Order {
  id              String   @id @db.Char(32)
  user_id         String   @db.Char(32)     // FIXED
  subtotal        Decimal  @db.Decimal(10, 2)
  discount_code   String?  @db.VarChar(50)
  discount_amount Decimal  @db.Decimal(10, 2)
  total_amount    Decimal  @db.Decimal(10, 2)
  created_at      DateTime @db.DateTime(6)

  @@map("orders_order")
}

/// Global/reusable coupon definitions (per-user single-use is tracked in UserCoupon)
model Coupon {
  id                  String         @id @db.Char(32)            // UUID hex(32)
  code                String         @unique(map: "code") @db.VarChar(50)
  type                String         @db.VarChar(20)             // 'percentage' | 'flat_rate' | 'hybrid'
  discount_percent    Decimal?       @db.Decimal(5, 2)           // for percentage/hybrid
  flat_amount         Decimal?       @db.Decimal(10, 2)          // for flat_rate
  max_discount_amount Decimal?       @db.Decimal(10, 2)          // for hybrid cap
  nth_value           Int                                            // every-nth order gate
  is_active           Boolean
  created_at          DateTime       @db.DateTime(6)

  userCoupons UserCoupon[]

  @@map("coupons_coupon")
}

/// Per-user redemption lock for a global coupon (each user can use a given code once)
model UserCoupon {
  id        BigInt   @id @default(autoincrement())
  order_id  String?  @db.Char(32)
  user_id   String   @db.Char(32)
  coupon_id String
  used_at   DateTime @db.DateTime(6)

  coupon    Coupon @relation(fields: [coupon_id], references: [id])

  @@unique([user_id, coupon_id])
  @@map("coupons_usercoupon")
}

/* ========= CART TABLES OWNED BY NODE (PRISMA) =========
   If you chose “Option B (frontend-only cart & send once on checkout)”
   you may skip creating these tables. If you DO want server carts for
   swagger demos/tests, keep them and run `prisma migrate`.
*/

model Cart {
  id         String    @id @default(dbgenerated("REPLACE(UUID(), '-', '')")) @db.Char(32)
  user_id    String
  created_at DateTime  @default(now())
  updated_at DateTime  @updatedAt

  items CartItem[]

  @@map("carts_cart")
}

model CartItem {
  id         String   @id @default(dbgenerated("REPLACE(UUID(), '-', '')")) @db.Char(32)
  cart_id    String
  product_id String
  quantity   Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  cart    Cart    @relation(fields: [cart_id], references: [id])
  product Product @relation(fields: [product_id], references: [id])

  @@unique([cart_id, product_id])
  @@map("carts_cartitem")
}
