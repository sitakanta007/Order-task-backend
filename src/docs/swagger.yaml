openapi: 3.0.0
info:
  title: Ecommerce API
  version: 1.0.0
  description: API documentation for the Ecommerce backend

servers:
  - url: http://localhost:5000/api

tags:
  - name: Products
    description: Product list & details
  - name: Orders
    description: Get orders
  - name: Cart
    description: Add products to Cart, and checkout
  - name: Coupons
    description: Coupon generation & usage
  - name: Customers
    description: Customer login & authentication
  - name: Auth
    description: Authentication related endpoints

paths:
  /products:
    get:
      tags:
        - Products
      summary: Get all products
      responses:
        200:
          description: List of products
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Product'
  /auth/login:
    post:
      tags:
        - Auth
      summary: User login
      description: Login using email and password. Returns JWT token on success.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  example: test@gmail.com
                password:
                  type: string
                  example: "123456"
      responses:
        "200":
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Login successful
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                        example: 4f3bfc58-ecf5-4ed3-8c2c-51301b27f10a
                      email:
                        type: string
                        example: test@gmail.com
                      name:
                        type: string
                        example: John Doe
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Email and password are required
        "401":
          description: Invalid email or password
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: Invalid email or password
        "500":
          description: Internal server error
  /cart/add:
    post:
      tags:
        - Cart
      summary: Add product to cart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                product_id:
                  type: string
                quantity:
                  type: number
      responses:
        "201":
          description: Product added to cart
  /cart/{userId}:
    get:
      tags:
        - Cart
      summary: Get user's cart
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        "200":
          description: User cart data
  /cart/update:
    post:
      tags:
        - Cart
      summary: Update entire cart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                items:
                  type: array
                  items:
                    type: object
                    properties:
                      product_id:
                        type: string
                      quantity:
                        type: number
      responses:
        "200":
          description: Cart updated
  /coupons/{userId}:
    get:
      tags:
        - Coupons
      summary: Get available coupons for the user
      description: >
        Returns the next eligible order number and up to 5 coupons whose
        `nth_value >= nextOrderNumber`.  
        Coupons already used by the user are excluded.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: 32-character Customer user ID
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of available coupons and the next order number
          content:
            application/json:
              schema:
                type: object
                properties:
                  nextOrderNumber:
                    type: integer
                    description: The next order index for the user
                  coupons:
                    type: array
                    description: Up to 5 available coupons
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        code:
                          type: string
                        type:
                          type: string
                          description: percentage | flat_rate | hybrid
                        discount_percent:
                          type: number
                          nullable: true
                        flat_amount:
                          type: number
                          nullable: true
                        max_discount_amount:
                          type: number
                          nullable: true
                        nth_value:
                          type: integer
                          description: Coupon applies to this order number or higher
        "400":
          description: Error response
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
  /cart/checkout:
    post:
      tags:
        - Cart
      summary: Checkout and place order
      description: >
        Syncs the user's cart with frontend items, validates coupon rules,
        recalculates pricing using DB product prices, applies discounts, adds GST,
        creates an order, order items, locks coupon usage, then deletes the user's cart.
      security:
        - bearerAuth: []

      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - items
                - subtotal
                - discount
                - tax
                - total_amount
              properties:
                user_id:
                  type: string
                  description: User ID (CHAR(32))
                  example: "c8e2d9a3b4f14a2fb3de0c318f7b1c15"
                items:
                  type: array
                  description: Cart items sent from frontend snapshot
                  items:
                    type: object
                    required: [product_id, quantity]
                    properties:
                      product_id:
                        type: string
                        example: "7f32a1ce98b247c59e609a431c0eecee"
                      quantity:
                        type: integer
                        example: 2
                      price:
                        type: number
                        description: >
                          Frontend price (ignored by backend validation; backend fetches price from DB)
                        example: 499
                subtotal:
                  type: number
                  description: >
                    Frontend-submitted subtotal. Backend recalculates subtotal using DB prices
                    and rejects the request if mismatch occurs.
                  example: 998
                discount:
                  type: number
                  description: >
                    Frontend discount preview. Backend recomputes discount based on valid coupon rules
                    and rejects mismatches.
                  example: 99
                tax:
                  type: number
                  description: >
                    Tax from frontend. Backend recomputes: GST = 5% of (subtotal - discount).
                  example: 44.95
                total_amount:
                  type: number
                  description: >
                    Final payable. Backend recomputes and rejects mismatches.
                  example: 943.95
                coupon:
                  type: string
                  nullable: true
                  description: Optional coupon code
                  example: "XYZ10"

      responses:
        200:
          description: Order successfully placed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Order placed successfully"
                  order_id:
                    type: string
                    example: "a91d2f8b9633423aa8a0b49dbbb430b1"
                  subtotal:
                    type: number
                    example: 998
                  discountAmount:
                    type: number
                    example: 99
                  tax:
                    type: number
                    example: 44.95
                  total_amount:
                    type: number
                    example: 943.95

        400:
          description: Invalid request or failed validation
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                examples:
                  priceMismatch:
                    summary: Subtotal mismatch
                    value:
                      message: "Subtotal mismatch. Please refresh cart."
                  couponInvalid:
                    summary: Invalid coupon
                    value:
                      message: "Invalid coupon code"
                  couponUsed:
                    summary: Coupon already used by same user
                    value:
                      message: "Coupon already used by this user"
                  couponNthBlocked:
                    summary: nth_value validation failed
                    value:
                      message: "Coupon not applicable for this order number"
  /orders/{userId}:
    get:
      summary: Get all orders for a user
      description: Returns a list of all orders placed by the user, including order items and product details.
      tags:
        - Orders
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
          description: User's UUID (32-char)
      responses:
        "200":
          description: List of user orders
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    order_id:
                      type: string
                    created_at:
                      type: string
                      format: date-time
                    subtotal:
                      type: number
                    discount_amount:
                      type: number
                    tax:
                      type: number
                    total_amount:
                      type: number
                    coupon_code:
                      type: string
                      nullable: true
                    items:
                      type: array
                      items:
                        type: object
                        properties:
                          product_id:
                            type: string
                          quantity:
                            type: number
                          price_at_time:
                            type: number
                          title:
                            type: string
                          image_url:
                            type: string
                            nullable: true
        "400":
          description: Error fetching orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
components:
  schemas:
    Product:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        description:
          type: string
        price:
          type: number
        image_url:
          type: string
        available_quantity:
          type: integer
